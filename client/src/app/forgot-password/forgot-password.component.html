<div class="fp-container">
  <div class="fp-card">
    <h2>Forgot Password</h2>
    <p class="subtext">Enter your registered email to receive an OTP.</p>

    <form [formGroup]="form" novalidate>

      <!-- ===================================================== -->
      <!-- Email + Send OTP + OTP entry — visible only before reset -->
      <!-- ===================================================== -->
      <ng-container *ngIf="!showReset">
        <!-- Email -->
        <div class="input-group">
          <label for="email">Email</label>
          <input id="email"
                 type="email"
                 formControlName="email"
                 placeholder="name@example.com"
                 [class.invalid]="email?.touched && email?.invalid" />
          <small class="error" *ngIf="email?.touched && email?.invalid">
            <span *ngIf="email?.errors?.['required']">Email is required.</span>
            <span *ngIf="email?.errors?.['email']">Enter a valid email address.</span>
          </small>
        </div>

        <!-- Single action: Send OTP -->
        <div class="btn-row">
          <button type="button"
                  class="btn primary-btn"
                  (click)="onRequestReset()"
                  [disabled]="email?.invalid || loading">
            {{ loading ? 'Sending…' : 'Send Reset OTP' }}
          </button>
        </div>

        <!-- Inline messages only while in OTP stage -->
        <div class="msg success" *ngIf="successMessage">{{ successMessage }}</div>
        <div class="msg error" *ngIf="errorMessage">{{ errorMessage }}</div>

        <!-- OTP section -->
        <div *ngIf="otpSent" class="otp-section">
          <div class="input-group">
            <label for="otp">Enter 6‑digit OTP</label>
            <input id="otp"
                   type="text"
                   maxlength="6"
                   formControlName="otp"
                   placeholder="______" />
          </div>

          <div class="btn-row">
            <button type="button" class="btn success-btn" (click)="onVerifyOtp()" [disabled]="loading">
              {{ loading ? 'Verifying…' : 'Verify OTP' }}
            </button>

            <button type="button" class="btn secondary-btn"
                    (click)="onResendOtp()"
                    [disabled]="resendDisabled || loading">
              Resend OTP <span *ngIf="resendDisabled">({{ countdown }}s)</span>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- ===================================================== -->
      <!-- RESET PASSWORD CARD — visible only after OTP verified -->
      <!-- ===================================================== -->
      <div *ngIf="showReset" class="reset-card">
        <h3>Reset your password</h3>
        <p class="subtext">Create a new strong password and confirm it.</p>

        <!-- New password -->
        <div class="input-group password-group">
          <label>New Password</label>
          <div class="password-wrapper">
            <input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="Create a strong password"
              (focus)="showChecklist = true"
              (blur)="hideChecklist()"
            />
            <span class="toggle-eye" (click)="togglePasswordVisibility()">
              <i class="fa" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </span>
          </div>

          <!-- Strength meter -->
          <div class="strength-wrapper" *ngIf="passwordValue">
            <div class="strength-header">
              <span>Password strength</span>
              <span class="strength-label" [ngClass]="strengthClass">{{ strengthLabel }}</span>
            </div>

            <div class="strength-bar">
              <div class="strength-fill"
                   [ngClass]="strengthClass"
                   [style.width.%]="strengthPercent"></div>
            </div>
          </div>

          <!-- Checklist -->
          <div class="password-checklist" *ngIf="showChecklist && !allValid">
            <p [class.valid]="hasMinLength"><span>{{ hasMinLength ? '✅' : '❌' }}</span> Minimum 8 characters</p>
            <p [class.valid]="hasLowerCase"><span>{{ hasLowerCase ? '✅' : '❌' }}</span> At least one lowercase letter</p>
            <p [class.valid]="hasUpperCase"><span>{{ hasUpperCase ? '✅' : '❌' }}</span> At least one uppercase letter</p>
            <p [class.valid]="hasDigit"><span>{{ hasDigit ? '✅' : '❌' }}</span> At least one digit</p>
            <p [class.valid]="hasSpecialChar"><span>{{ hasSpecialChar ? '✅' : '❌' }}</span> At least one special character</p>
          </div>
        </div>

        <!-- Confirm password -->
        <div class="input-group password-group">
          <label>Confirm Password</label>
          <div class="password-wrapper">
            <input
              [type]="showConfirmPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Re-enter your password"
            />
            <span class="toggle-eye" (click)="toggleConfirmPasswordVisibility()">
              <i class="fa" [ngClass]="showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </span>
          </div>

          <small class="error" *ngIf="form.hasError('passwordMismatch') && confirmPassword?.touched">
            Passwords do not match
          </small>
        </div>

        <div class="btn-row">
          <button type="button" class="btn primary-btn" (click)="onResetPassword()" [disabled]="loading">
            {{ loading ? 'Updating…' : 'Update Password' }}
          </button>
        </div>
      </div>

      <div class="back">
        <a routerLink="/login">← Back to Login</a>
      </div>
    </form>
  </div>
</div>

