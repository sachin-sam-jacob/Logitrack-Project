<div class="fp-container">
  <!-- Particle Canvas Background -->
  <canvas #particleCanvas class="particle-canvas"></canvas>

  <!-- Back to Login Button -->
  <button class="back-home-btn" routerLink="/login">
    <span>←</span> Back to Login
  </button>

  <div class="fp-card">
    <!-- Header Section -->
    <div class="fp-header">
      <i class="header-icon fa" [ngClass]="showReset ? 'fa-key' : 'fa-unlock-alt'"></i>
      <h2>{{ showReset ? 'Create New Password' : 'Forgot Password?' }}</h2>
      <p class="subtext">
        {{ showReset 
          ? 'Enter a strong password to secure your account' 
          : 'No worries, we\'ll send you reset instructions' }}
      </p>
    </div>

    <form [formGroup]="form" novalidate>

      <!-- ===================================================== -->
      <!-- EMAIL & OTP SECTION -->
      <!-- ===================================================== -->
      <div *ngIf="!showReset" class="form-section">
        
        <!-- Email Input -->
        <div class="input-group" [class.has-error]="email?.touched && email?.invalid">
          <label for="email">
            <i class="fa fa-envelope"></i>
            Email Address
          </label>
          <input 
            id="email"
            type="email"
            formControlName="email"
            placeholder="Enter your registered email"
            [class.invalid]="email?.touched && email?.invalid" 
          />
          <small class="error" *ngIf="email?.touched && email?.invalid">
            <i class="fa fa-exclamation-circle"></i>
            <span *ngIf="email?.errors?.['required']">Email is required</span>
            <span *ngIf="email?.errors?.['email']">Please enter a valid email</span>
          </small>
        </div>

        <!-- Send OTP Button -->
        <button 
          type="button"
          class="btn primary-btn"
          (click)="onRequestReset()"
          [disabled]="email?.invalid || loading"
          *ngIf="!otpSent">
          <span *ngIf="!loading">
            <i class="fa fa-paper-plane"></i>
            Send Reset Code
          </span>
          <span *ngIf="loading" class="loading-spinner">
            <i class="fa fa-spinner fa-spin"></i>
            Sending...
          </span>
        </button>

        <!-- Success/Error Messages -->
        <div class="alert alert-success" *ngIf="successMessage">
          <i class="fa fa-check-circle"></i>
          {{ successMessage }}
        </div>
        <div class="alert alert-error" *ngIf="errorMessage">
          <i class="fa fa-exclamation-triangle"></i>
          {{ errorMessage }}
        </div>

        <!-- OTP Input Section -->
        <div *ngIf="otpSent" class="otp-section">
          <div class="otp-header">
            <i class="fa fa-shield-alt"></i>
            <h3>Verification Code</h3>
            <p>Enter the 6-digit code sent to your email</p>
          </div>

          <div class="input-group">
            <input 
              id="otp"
              type="text"
              maxlength="6"
              formControlName="otp"
              placeholder="• • • • • •"
              class="otp-input"
            />
          </div>

          <div class="otp-actions">
            <button 
              type="button" 
              class="btn verify-btn" 
              (click)="onVerifyOtp()" 
              [disabled]="loading || !form.value.otp || form.value.otp.length !== 6">
              <span *ngIf="!loading">
                <i class="fa fa-check"></i>
                Verify Code
              </span>
              <span *ngIf="loading" class="loading-spinner">
                <i class="fa fa-spinner fa-spin"></i>
                Verifying...
              </span>
            </button>

            <button 
              type="button" 
              class="btn resend-btn"
              (click)="onResendOtp()"
              [disabled]="resendDisabled || loading">
              <i class="fa fa-redo"></i>
              <span *ngIf="!resendDisabled">Resend Code</span>
              <span *ngIf="resendDisabled">Resend in {{ countdown }}s</span>
            </button>
          </div>
        </div>
      </div>

      <!-- ===================================================== -->
      <!-- RESET PASSWORD SECTION -->
      <!-- ===================================================== -->
      <div *ngIf="showReset" class="form-section reset-section">
        
        <!-- New Password -->
        <div class="input-group password-group" [class.has-error]="newPassword?.touched && newPassword?.invalid">
          <label>
            <i class="fa fa-key"></i>
            New Password
          </label>
          <div class="password-wrapper">
            <input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="newPassword"
              placeholder="Create a strong password"
              (focus)="showChecklist = true"
              (blur)="hideChecklist()"
            />
            <span class="toggle-eye" (click)="togglePasswordVisibility()">
              <i class="fa" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </span>
          </div>

          <!-- Strength Meter -->
          <div class="strength-meter" *ngIf="passwordValue">
            <div class="strength-info">
              <span class="strength-text">Password Strength:</span>
              <span class="strength-label" [ngClass]="strengthClass">
                {{ strengthLabel }}
              </span>
            </div>
            <div class="strength-bar">
              <div class="strength-fill" 
                   [ngClass]="strengthClass"
                   [style.width.%]="strengthPercent">
              </div>
            </div>
          </div>

          <!-- Password Requirements -->
          <div class="password-requirements" *ngIf="showChecklist && !allValid">
            <p class="requirements-title">Password must contain:</p>
            <div class="requirements-list">
              <div class="requirement" [class.met]="hasMinLength">
                <i class="fa" [ngClass]="hasMinLength ? 'fa-check-circle' : 'fa-circle'"></i>
                At least 8 characters
              </div>
              <div class="requirement" [class.met]="hasLowerCase">
                <i class="fa" [ngClass]="hasLowerCase ? 'fa-check-circle' : 'fa-circle'"></i>
                One lowercase letter
              </div>
              <div class="requirement" [class.met]="hasUpperCase">
                <i class="fa" [ngClass]="hasUpperCase ? 'fa-check-circle' : 'fa-circle'"></i>
                One uppercase letter
              </div>
              <div class="requirement" [class.met]="hasDigit">
                <i class="fa" [ngClass]="hasDigit ? 'fa-check-circle' : 'fa-circle'"></i>
                One number
              </div>
              <div class="requirement" [class.met]="hasSpecialChar">
                <i class="fa" [ngClass]="hasSpecialChar ? 'fa-check-circle' : 'fa-circle'"></i>
                One special character
              </div>
            </div>
          </div>
        </div>

        <!-- Confirm Password -->
        <div class="input-group password-group" [class.has-error]="form.hasError('passwordMismatch') && confirmPassword?.touched">
          <label>
            <i class="fa fa-lock"></i>
            Confirm Password
          </label>
          <div class="password-wrapper">
            <input
              [type]="showConfirmPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Re-enter your password"
            />
            <span class="toggle-eye" (click)="toggleConfirmPasswordVisibility()">
              <i class="fa" [ngClass]="showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
            </span>
          </div>
          <small class="error" *ngIf="form.hasError('passwordMismatch') && confirmPassword?.touched">
            <i class="fa fa-exclamation-circle"></i>
            Passwords do not match
          </small>
        </div>

        <!-- Reset Button -->
        <button 
          type="button" 
          class="btn primary-btn" 
          (click)="onResetPassword()" 
          [disabled]="loading || !allValid || form.hasError('passwordMismatch')">
          <span *ngIf="!loading">
            <i class="fa fa-check-circle"></i>
            Reset Password
          </span>
          <span *ngIf="loading" class="loading-spinner">
            <i class="fa fa-spinner fa-spin"></i>
            Updating...
          </span>
        </button>
      </div>
    </form>
  </div>

  <!-- Footer -->
  <div class="fp-footer">
    <p>© 2026 LogiTrack. All rights reserved.</p>
  </div>
</div>